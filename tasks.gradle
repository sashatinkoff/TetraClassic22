def versionPropsFile = file('version.properties')

/*Wrapping inside a method avoids auto incrementing on every gradle task run. Now it runs only when we build apk*/
ext.autoIncrementBuildNumber = {
    def versionBuild = 1
    Properties versionProps = new Properties()
    if (!versionPropsFile.exists()) versionPropsFile.createNewFile()
    else {
        versionProps.load(new FileInputStream(versionPropsFile))
        versionBuild = versionProps['VERSION_BUILD'].toInteger() + 1
    }

    versionProps['VERSION_BUILD'] = versionBuild.toString()
    versionProps.store(versionPropsFile.newWriter(), null)
}

// Hook to check if the release/debug task is among the tasks to be executed.
//Let's make use of it
gradle.taskGraph.whenReady { taskGraph ->
    def branchName = gitBranch()

    taskGraph.allTasks.iterator().forEachRemaining { t ->
//        println("tasssssk=${t.name} in $branchName")

        //  || t.name == "bundleProdRealRelease"
        if (branchName == "master" && (t.name == "bundleProdRelease")) {
            autoIncrementBuildNumber()
        }
    }
}


def gitBranch() {
    def branch = ""
    def proc = "git rev-parse --abbrev-ref HEAD".execute()
    proc.in.eachLine { line -> branch = line }
//    proc.err.eachLine { line -> println line }
    proc.waitFor()
    branch
}